@{
    if (Request.IsAjaxRequest())
    {
        Layout = null;
    }
}

<head>

</head>

<br />

<div id="MainDiv" class="panel panel-default ">
    <div class="panel panel-default ">
        <div class="panel-heading">
            <h5 class="panel-title"><i class="icon-stack-plus position-left"></i>Create Knitting Order</h5>
        </div>
        <div class="panel-body">
            <form id="UserForm">
                <div class=" form-group">
                    <div class="form-group col-xs-4 form-inline">
                        <label for="Name" class="control-label" style="width:25%;">Name</label>
                        <div style=" display: inline;">
                            <input type="text" class="form-control" style="width:70%;" id="Name" required>
                        </div>
                    </div>
                    <div class="form-group col-xs-4 form-inline">
                        <label for="UserName" class="control-label" style="width:25%;">User Name</label>
                        <div style=" display: inline;">
                            <input type="email" class="form-control" style="width:70%;" id="UserName" required>
                        </div>
                    </div>
                    <div class="form-group col-xs-4 form-inline">
                        <label for="Password" class="control-label" style="width:25%;">Password</label>
                        <div style="display: inline;">
                            <input type="text" class="form-control" style="width:70%;" id="Password" required>
                        </div>
                    </div>
                </div>
                <div class=" form-group">
                    <div class="form-group col-xs-1 form-inline">
                        <label for="Role" class="control-label" style="width:100%;">Roles</label>
                    </div>
                    <div class="form-group col-xs-3 form-inline">
                        <div style="display: inline;">
                            <div id="Role" class="treeSelector" style="width:100%;display: inline-block;"></div>
                        </div>
                    </div>
                    <div class="form-group col-xs-6 form-inline">
                        <button class="btn btn-warning btn-sm" style="width:25%;" id="resetBtn">Reset</button>
                        <div style="display: inline;">
                            <input type="submit" value="Save" class="btn btn-success btn-sm" style="width:22%;" id="saveBtn">
                        </div>
                        <div style="display: inline;">
                            <input type="submit" value="Update" class="btn btn-primary btn-sm" disabled="disabled" style="width:23%;" id="updateBtn">
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <button class="btn btn-danger btn-sm" style="width:10%; margin-bottom:15px;" id="deleteBtn">Delete Row</button>
    <table id="UserTable" class="display nowrap stripe hover order-column" style="width:1100px">
        <thead>
            <tr>
                <th></th>
                <th>Name</th>
                <th>UserName</th>
                <th>Password</th>
            </tr>
        </thead>
    </table>
</div>

<script>

    $(document).ready(function () {

        debugger;
        var PermissionString = ""; var vals = [];

        var rootNode = [
            {
                "Id": "1",
                "value": 1,
                "val": 0,
                "title": "Fabric",
                "children": [
                    {
                        "Id": "1_1",
                        "ParentID": 1,
                        "title": "Crud",
                        "value": 11,
                        "val": 0,
                        "children": []
                    },
                    {
                        "Id": "1_2",
                        "ParentID": 1,
                        "value": 12,
                        "val": 0,
                        "title": "LibrarySet",
                        "children": []
                    },
                    {
                        "Id": "1_3",
                        "ParentID": 1,
                        "value": 13,
                        "val": 0,
                        "title": "Approval",
                        "children": []
                    }
                ]
            },
            {
                "Id": "2",
                "value": 2,
                "val": 0,
                "title": "Knit",
                "children": [
                    {
                        "Id": "2_1",
                        "ParentID": 2,
                        "title": "Crud",
                        "value": 21,
                        "val": 0,
                        "children": []
                    },
                    {
                        "Id": "2_2",
                        "ParentID": 2,
                        "value": 22,
                        "val": 0,
                        "title": "LibrarySet",
                        "children": []
                    },
                    {
                        "Id": "2_3",
                        "ParentID": 2,
                        "value": 23,
                        "val": 0,
                        "title": "Approval",
                        "children": []
                    }
                ]
            },
            {
                "Id": "3",
                "value": 3,
                "val": 0,
                "title": "CW",
                "children": [
                    {
                        "Id": "3_1",
                        "ParentID": 3,
                        "title": "Crud",
                        "value": 31,
                        "val": 0,
                        "children": []
                    },
                    {
                        "Id": "3_3",
                        "ParentID": 3,
                        "value": 33,
                        "val": 0,
                        "title": "LibrarySet",
                        "children": []
                    },
                    {
                        "Id": "3_3",
                        "ParentID": 3,
                        "value": 33,
                        "val": 0,
                        "title": "Approval",
                        "children": []
                    }
                ]
            },
            {
                "Id": "4",
                "value": 4,
                "val": 0,
                "title": "HSP",
                "children": [
                    {
                        "Id": "4_1",
                        "ParentID": 4,
                        "title": "Crud",
                        "value": 41,
                        "val": 0,
                        "children": []
                    },
                    {
                        "Id": "4_4",
                        "ParentID": 4,
                        "value": 44,
                        "val": 0,
                        "title": "LibrarySet",
                        "children": []
                    },
                    {
                        "Id": "4_4",
                        "ParentID": 4,
                        "value": 44,
                        "val": 0,
                        "title": "Approval",
                        "children": []
                    }
                ]
            },
            {
                "Id": "5",
                "value": 5,
                "val": 0,
                "title": "Singeing",
                "children": [
                    {
                        "Id": "5_1",
                        "ParentID": 5,
                        "title": "Crud",
                        "value": 51,
                        "val": 0,
                        "children": []
                    },
                    {
                        "Id": "5_5",
                        "ParentID": 5,
                        "value": 55,
                        "val": 0,
                        "title": "LibrarySet",
                        "children": []
                    },
                    {
                        "Id": "5_5",
                        "ParentID": 5,
                        "value": 55,
                        "val": 0,
                        "title": "Approval",
                        "children": []
                    }
                ]
            },
            {
                "Id": "6",
                "value": 6,
                "val": 0,
                "title": "Dyeing",
                "children": [
                    {
                        "Id": "6_1",
                        "ParentID": 6,
                        "title": "Crud",
                        "value": 61,
                        "val": 0,
                        "children": []
                    },
                    {
                        "Id": "6_6",
                        "ParentID": 6,
                        "value": 66,
                        "val": 0,
                        "title": "LibrarySet",
                        "children": []
                    },
                    {
                        "Id": "6_6",
                        "ParentID": 6,
                        "value": 66,
                        "val": 0,
                        "title": "Approval",
                        "children": []
                    }
                ]
            },
            {
                "Id": "7",
                "value": 7,
                "val": 0,
                "title": "Dryer",
                "children": [
                    {
                        "Id": "7_1",
                        "ParentID": 7,
                        "title": "Crud",
                        "value": 71,
                        "val": 0,
                        "children": []
                    },
                    {
                        "Id": "7_7",
                        "ParentID": 7,
                        "value": 77,
                        "val": 0,
                        "title": "LibrarySet",
                        "children": []
                    },
                    {
                        "Id": "7_7",
                        "ParentID": 7,
                        "value": 77,
                        "val": 0,
                        "title": "Approval",
                        "children": []
                    }
                ]
            },
            {
                "Id": "8",
                "value": 8,
                "val": 0,
                "title": "Stenter",
                "children": [
                    {
                        "Id": "8_1",
                        "ParentID": 8,
                        "title": "Crud",
                        "value": 81,
                        "val": 0,
                        "children": []
                    },
                    {
                        "Id": "8_8",
                        "ParentID": 8,
                        "value": 88,
                        "val": 0,
                        "title": "LibrarySet",
                        "children": []
                    },
                    {
                        "Id": "8_8",
                        "ParentID": 8,
                        "value": 88,
                        "val": 0,
                        "title": "Approval",
                        "children": []
                    }
                ]
            },
            {
                "Id": "9",
                "value": 9,
                "val": 0,
                "title": "Compacting",
                "children": [
                    {
                        "Id": "9_1",
                        "ParentID": 9,
                        "title": "Crud",
                        "value": 91,
                        "val": 0,
                        "children": []
                    },
                    {
                        "Id": "9_9",
                        "ParentID": 9,
                        "value": 99,
                        "val": 0,
                        "title": "LibrarySet",
                        "children": []
                    },
                    {
                        "Id": "9_9",
                        "ParentID": 9,
                        "value": 99,
                        "val": 0,
                        "title": "Approval",
                        "children": []
                    }
                ]
            },
            {
                "Id": "10",
                "value": 10,
                "val": 0,
                "title": "Peach",
                "children": [
                    {
                        "Id": "10_1",
                        "ParentID": 10,
                        "title": "Crud",
                        "value": 101,
                        "val": 0,
                        "children": []
                    },
                    {
                        "Id": "10_10",
                        "ParentID": 10,
                        "value": 1010,
                        "val": 0,
                        "title": "LibrarySet",
                        "children": []
                    },
                    {
                        "Id": "10_10",
                        "ParentID": 10,
                        "value": 1010,
                        "val": 0,
                        "title": "Approval",
                        "children": []
                    }
                ]
            },
            {
                "Id": "11",
                "value": 11,
                "val": 0,
                "title": "Brush",
                "children": [
                    {
                        "Id": "11_1",
                        "ParentID": 11,
                        "title": "Crud",
                        "value": 111,
                        "val": 0,
                        "children": []
                    },
                    {
                        "Id": "11_11",
                        "ParentID": 11,
                        "value": 1111,
                        "val": 0,
                        "title": "LibrarySet",
                        "children": []
                    },
                    {
                        "Id": "11_11",
                        "ParentID": 11,
                        "value": 1111,
                        "val": 0,
                        "title": "Approval",
                        "children": []
                    }
                ]
            },
            {
                "Id": "12",
                "value": 12,
                "val": 0,
                "title": "Print",
                "children": [
                    {
                        "Id": "12_1",
                        "ParentID": 12,
                        "title": "Crud",
                        "value": 121,
                        "val": 0,
                        "children": []
                    },
                    {
                        "Id": "12_12",
                        "ParentID": 12,
                        "value": 1212,
                        "val": 0,
                        "title": "LibrarySet",
                        "children": []
                    },
                    {
                        "Id": "12_12",
                        "ParentID": 12,
                        "value": 1212,
                        "val": 0,
                        "title": "Approval",
                        "children": []
                    }
                ]
            },
            {
                "Id": "13",
                "value": 13,
                "val": 0,
                "title": "QC",
                "children": [
                    {
                        "Id": "13_1",
                        "ParentID": 13,
                        "title": "Crud",
                        "value": 131,
                        "val": 0,
                        "children": []
                    },
                    {
                        "Id": "13_13",
                        "ParentID": 13,
                        "value": 1313,
                        "val": 0,
                        "title": "LibrarySet",
                        "children": []
                    },
                    {
                        "Id": "13_13",
                        "ParentID": 13,
                        "value": 1313,
                        "val": 0,
                        "title": "Approval",
                        "children": []
                    }
                ]
            }
        ];

        $('div.treeSelector').treeSelector(rootNode, [], function (e, values) {
            debugger;
            vals = values;
        }, {
                checkWithParent: true,
                titleWithParent: true,
                notViewClickParentTitle: false,
                disabled: false,
                emptyOptonPlaceholder: 'asd'

            });

        var UserTable = $('#UserTable').DataTable({
            buttons: [],
            "ajax":
            {
                "url": "/UserManagement/GetData",
                "type": "GET",
                "dataType": "JSON"
            },
            "scrollY": true,
            "scrollX": true,
            "Sorting": true,
            "searching": true,
            "destroy": true,
            "autoWidth": false,
            "select": {
                style: 'single'
            },
            "columnDefs": [
                {
                    "targets": [0],
                    "searchable": false,
                    "orderable": false,
                }
            ],

            "columns": [
                {
                    "searchable": false,
                    "render": function (data, type, full, meta) {
                        return UserTable.data().count();
                    }
                },
                { "data": "Name" },
                { "data": "UserName" },
                { "data": "Password" }
            ]
        }).columns.adjust().draw();

        function IsValid() {
            if ($('#Fabric').is(':checked')) {
                PermissionString = PermissionString + "1,";
            }
            if ($('#Knitting').is(':checked')) {
                PermissionString = PermissionString + "2,";
            }
            if ($('#Dyeing').is(':checked')) {
                PermissionString = PermissionString + "3,";
            }
            if ($('#Slitting').is(':checked')) {
                PermissionString = PermissionString + "4,";
            }
            if ($('#Stenter').is(':checked')) {
                PermissionString = PermissionString + "5,";
            }
            if ($('#Aop').is(':checked')) {
                PermissionString = PermissionString + "6,";
            }
            if ($('#Test').is(':checked')) {
                PermissionString = PermissionString + "7,";

            }
            if ($('#Remarks').is(':checked')) {
                PermissionString = PermissionString + "8,";
            }

            if (PermissionString != "") {
                PermissionString = PermissionString.replace(/,\s*$/, "");
                return true;
            }
            else {
                return false;
            }
        }

        function Reset() {
            event.preventDefault();
            debugger;
            $('#saveBtn').prop("disabled", false);
            $('#updateBtn').prop("disabled", true);
            $("#Name").val("");
            $("#UserName").val("");
            $("#Password").val("");

            $('div.treeSelector').treeSelector(rootNode, [], function (e, values) {
                debugger;
                vals = [];
            }, {
                    checkWithParent: true,
                    titleWithParent: true,
                    notViewClickParentTitle: false,
                    disabled: false,
                    emptyOptonPlaceholder: 'asd'

                });

            PermissionString = "";
            vals = [];
        }

        function findValueInArray(value, vals) {
            var result = false;
            for (var i = 0; i < vals.length; i++) {
                if (vals[i] == value) {
                    result = true;
                    break;
                }
            }
            return result;
        }

        $('#UserForm').submit(function (e) {
            debugger;
            event.preventDefault();

            rootNode.forEach(function (item, i) {
                item.children.forEach(function (a, j) {
                    if (findValueInArray(a["value"], vals) == true) {
                        item["val"] = 1; a["val"] = 1;
                    }
                    else {
                        a["val"] = 0;
                    };
                });
            });

            var user = {
                Id: '0',
                Name: $("#Name").val(),
                UserName: $("#UserName").val(),
                Password: $("#Password").val(),
                rootNode: rootNode,
                PermissionString: PermissionString,
                CreateDate: moment(Date.now()).format("DD/MM/YYYY")
            };

            $.ajax({
                type: "POST",
                url: "/UserManagement/Create",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: JSON.stringify(user),
                success: function (response) {
                    debugger
                    if (response.data != "" && response.data != null) {
                        UserTable.row.add(response.data).draw();
                        Reset();
                    }
                    else {
                        alert("Failed to Save! Please Check Connection State!!!");
                        return;
                    }
                },
                failure: function () {
                    $("#tblItems").append(" Error when fetching data please contact administrator");
                }
            });

        });

        $("#deleteBtn").click(function () {
            event.preventDefault();
            if ($('#UserTable tbody tr').hasClass('selected')) {
                $.ajax({
                    type: "POST",
                    url: "/UserManagement/Delete",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: UserTable.rows('.selected').data()[0].Id,
                    success: function (response) {
                        if (response == "Success") {
                            UserTable.row('.selected').remove().draw(false);
                            alert("Delete Successfully!!!");
                            Reset();
                        }
                        else {
                            alert("Failed to Delete! Please Check Connection State!!!");
                            return;
                        }
                    },
                    failure: function () {
                        $("#tblItems").append(" Error when fetching data please contact administrator");
                    }
                });
            }
            else {
                alert("Please Select A Row!!!");
                return;
            }

        });

        $("#resetBtn").click(function () {
            event.preventDefault();
            debugger;
            Reset();

        });

        $('#UserTable tbody').on('click', 'tr', function () {
            debugger;

            if ($(this).hasClass('selected')) {
                Reset();
                $(this).removeClass('selected');
            }
            else {
                var rowdata = UserTable.row(this).data();
                UserTable.$('tr.selected').removeClass('selected');
                $(this).addClass('selected');
                Setvalue(rowdata);

            }
        });

        function GetSelectedNode(Nodes) {
            debugger;
            var arr = [];
            Nodes.forEach(function (item, i) {
                item.children.forEach(function (a, j) {
                    if (a["val"] == 1) {
                        arr.push(a.value);
                    }
                });
            });
            return arr;
        }

        function Setvalue(rowdata) {
            debugger;
            Reset();
            $('#saveBtn').prop("disabled", true);
            $('#updateBtn').prop("disabled", false);
            $("#Name").val(rowdata.Name);
            $("#UserName").val(rowdata.UserName);
            $("#Password").val(rowdata.Password);

            var user = {
                UserName: rowdata.UserName
            };

            $.ajax({
                type: "POST",
                url: "/UserManagement/Details",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: JSON.stringify(user),
                success: function (response) {
                    debugger;
                    if (response.data != "" && response.data != null) {
                        $('div.treeSelector').treeSelector(rootNode, GetSelectedNode(response.data.rootNode), function (e, values) {
                            debugger;
                            vals = values;
                        }, {
                                checkWithParent: true,
                                titleWithParent: true,
                                notViewClickParentTitle: false,
                                disabled: false,
                                emptyOptonPlaceholder: 'asd'

                            });
                    }
                    else {
                        alert("Failed to Fetch! Please Check Connection State!!!");
                        return;
                    }
                },
                failure: function () {
                    $("#tblItems").append(" Error when fetching data please contact administrator");
                }
            });

        }

        $("#updateBtn").click(function () {
            event.preventDefault();

            debugger
            if ($('#UserTable tbody tr').hasClass('selected')) {
                debugger
                var Row = UserTable.rows('.selected').data()[0];
                var index = UserTable.row('.selected').index();

                rootNode.forEach(function (item, i) {
                    item.children.forEach(function (a, j) {
                        if (findValueInArray(a["value"], vals) == true) {
                            item["val"] = 1; a["val"] = 1;
                        }
                        else {
                            a["val"] = 0;
                        };
                    });
                });

                var user = {
                    Id: '0',
                    Name: $("#Name").val(),
                    UserName: $("#UserName").val(),
                    Password: $("#Password").val(),
                    rootNode: rootNode
                };

                $.ajax({
                    type: "POST",
                    url: "/UserManagement/Update",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: JSON.stringify(user),
                    success: function (response) {
                        debugger
                        if (response.data != "" && response.data != null) {
                            debugger
                            UserTable.row(index).data(response.data).draw();
                            Reset();
                        }
                        else {
                            alert("Failed to Update!!!");
                            return;
                        }
                    },
                    failure: function () {
                        $("#tblItems").append(" Error when fetching data please contact administrator");
                    }
                });
            }
            else {
                alert("Please Select A Row!!!");
                return;
            }

        });

    });


</script>